name: Auto Label and Assign

on:
  pull_request:
    types: [opened, synchronize, edited]

jobs:
  automation:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
      issues: write

    steps:
      - name: Smart Labeler and Assignee
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title;
            const prNumber = pr.number;

            console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
            console.log(`ğŸ“ PR Title: ${title}`);

            // 1. PR ì œëª©ì—ì„œ íƒ€ì… ì¶”ì¶œ (ì˜ˆ: "feat: ê¸°ëŠ¥" -> "feat")
            const typeMatch = title.match(/^([a-zA-Z]+)(\s*):/);
            if (!typeMatch) {
              console.log("âš ï¸ No type prefix found in PR title.");
              return;
            }
            const type = typeMatch[1].toLowerCase();
            console.log(`ğŸ” Search Keyword: ${type}`);

            // 2. ë ˆí¬ì§€í† ë¦¬ì— ì‹¤ì œ ë“±ë¡ëœ ë¼ë²¨ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            const { data: repoLabels } = await github.rest.issues.listLabelsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            // 3. ì¶”ì¶œí•œ í‚¤ì›Œë“œ(type)ê°€ í¬í•¨ëœ ë¼ë²¨ ì°¾ê¸°
            // ì˜ˆ: typeì´ 'feat'ì´ë©´ 'feat ğŸš€'ë‚˜ 'feature' ë“±ì„ ì°¾ìŒ
            const matchedLabel = repoLabels.find(l => 
              l.name.toLowerCase().includes(type)
            );

            // 4. ë‹´ë‹¹ì í• ë‹¹ (PR ìƒì„±ì)
            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              assignees: [pr.user.login]
            });

            // 5. ë§¤ì¹­ëœ ë¼ë²¨ì´ ìˆìœ¼ë©´ ë¶€ì°©
            if (matchedLabel) {
              console.log(`âœ… Found Matching Label: ${matchedLabel.name}`);
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: [matchedLabel.name]
              });
            } else {
              console.log(`âŒ No label in repo matches the keyword: ${type}`);
            }
            console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");